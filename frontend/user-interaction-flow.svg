<svg width="1200" height="1600" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <style>
      .box { fill: #e3f2fd; stroke: #1976d2; stroke-width: 2; rx: 8; }
      .decision { fill: #fff3e0; stroke: #f57c00; stroke-width: 2; }
      .process { fill: #e8f5e8; stroke: #388e3c; stroke-width: 2; rx: 8; }
      .error { fill: #ffebee; stroke: #d32f2f; stroke-width: 2; rx: 8; }
      .text { font-family: Arial, sans-serif; font-size: 12px; text-anchor: middle; }
      .title { font-family: Arial, sans-serif; font-size: 14px; font-weight: bold; text-anchor: middle; }
      .arrow { stroke: #333; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
      .error-arrow { stroke: #d32f2f; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#333" />
    </marker>
  </defs>
  
  <!-- 标题 -->
  <text x="600" y="30" class="title" font-size="18">用户语音指令处理流程图</text>
  
  <!-- 1. 用户开始 -->
  <rect x="520" y="60" width="160" height="40" class="box" />
  <text x="600" y="85" class="title">用户说出指令</text>
  
  <!-- 2. 语音识别启动 -->
  <rect x="520" y="130" width="160" height="40" class="process" />
  <text x="600" y="155" class="text">VoiceCoordinator启动STT</text>
  
  <!-- 3. 状态管理 -->
  <rect x="520" y="200" width="160" height="40" class="process" />
  <text x="600" y="220" class="text">InteractionContext</text>
  <text x="600" y="235" class="text">状态: LISTENING</text>
  
  <!-- 4. 语音转录 -->
  <rect x="520" y="270" width="160" height="40" class="process" />
  <text x="600" y="295" class="text">语音转录为文本</text>
  
  <!-- 5. 错误检查 -->
  <polygon points="520,340 600,320 680,340 600,360" class="decision" />
  <text x="600" y="345" class="text">语音识别成功?</text>
  
  <!-- 语音错误处理 -->
  <rect x="750" y="320" width="160" height="40" class="error" />
  <text x="830" y="340" class="text">UnifiedErrorHandler</text>
  <text x="830" y="355" class="text">处理语音错误</text>
  
  <!-- 6. 状态更新为思考 -->
  <rect x="520" y="390" width="160" height="40" class="process" />
  <text x="600" y="410" class="text">状态: THINKING</text>
  <text x="600" y="425" class="text">保存transcript</text>
  
  <!-- 7. 用户认证检查 -->
  <polygon points="520,460 600,440 680,460 600,480" class="decision" />
  <text x="600" y="465" class="text">用户已认证?</text>
  
  <!-- 认证失败 -->
  <rect x="750" y="440" width="160" height="40" class="error" />
  <text x="830" y="465" class="text">返回认证错误</text>
  
  <!-- 8. 会话ID初始化 -->
  <rect x="520" y="510" width="160" height="40" class="process" />
  <text x="600" y="535" class="text">初始化/获取sessionId</text>
  
  <!-- 9. API调用 -->
  <rect x="520" y="580" width="160" height="40" class="process" />
  <text x="600" y="600" class="text">调用apiClient.interpret</text>
  <text x="600" y="615" class="text">(意图识别)</text>
  
  <!-- 10. API响应检查 -->
  <polygon points="520,650 600,630 680,650 600,670" class="decision" />
  <text x="600" y="655" class="text">API调用成功?</text>
  
  <!-- API错误处理 -->
  <rect x="750" y="630" width="160" height="40" class="error" />
  <text x="830" y="650" class="text">UnifiedErrorHandler</text>
  <text x="830" y="665" class="text">处理API错误</text>
  
  <!-- 11. 响应类型判断 -->
  <polygon points="520,720 600,700 680,720 600,740" class="decision" />
  <text x="600" y="720" class="text">需要工具调用?</text>
  <text x="600" y="735" class="text">(requiresToolCall)</text>
  
  <!-- 12a. 工具调用路径 -->
  <rect x="350" y="770" width="160" height="40" class="process" />
  <text x="430" y="795" class="text">需要用户确认?</text>
  
  <!-- 确认模态框 -->
  <polygon points="270,840 350,820 430,840 350,860" class="decision" />
  <text x="350" y="845" class="text">显示确认模态框</text>
  
  <!-- 用户确认 -->
  <rect x="100" y="890" width="120" height="40" class="box" />
  <text x="160" y="915" class="text">用户确认</text>
  
  <!-- 用户取消 -->
  <rect x="250" y="890" width="120" height="40" class="box" />
  <text x="310" y="915" class="text">用户取消</text>
  
  <!-- 用户重试 -->
  <rect x="400" y="890" width="120" height="40" class="box" />
  <text x="460" y="915" class="text">用户重试</text>
  
  <!-- 工具执行 -->
  <rect x="270" y="960" width="160" height="40" class="process" />
  <text x="350" y="985" class="text">执行工具调用</text>
  
  <!-- 工具执行结果 -->
  <polygon points="270,1030 350,1010 430,1030 350,1050" class="decision" />
  <text x="350" y="1035" class="text">工具执行成功?</text>
  
  <!-- 工具错误处理 -->
  <rect x="100" y="1010" width="120" height="40" class="error" />
  <text x="160" y="1030" class="text">工具执行</text>
  <text x="160" y="1045" class="text">错误处理</text>
  
  <!-- 12b. 直接响应路径 -->
  <rect x="690" y="770" width="160" height="40" class="process" />
  <text x="770" y="795" class="text">直接文本响应</text>
  
  <!-- 13. TTS播报 -->
  <rect x="520" y="1100" width="160" height="40" class="process" />
  <text x="600" y="1120" class="text">状态: SPEAKING</text>
  <text x="600" y="1135" class="text">TTS播报响应</text>
  
  <!-- 14. 会话历史保存 -->
  <rect x="520" y="1170" width="160" height="40" class="process" />
  <text x="600" y="1190" class="text">保存会话历史</text>
  <text x="600" y="1205" class="text">(localStorage)</text>
  
  <!-- 15. 状态重置 -->
  <rect x="520" y="1240" width="160" height="40" class="process" />
  <text x="600" y="1260" class="text">状态: IDLE</text>
  <text x="600" y="1275" class="text">重新启动语音监听</text>
  
  <!-- 16. 完成 -->
  <rect x="520" y="1310" width="160" height="40" class="box" />
  <text x="600" y="1335" class="title">等待下一次指令</text>
  
  <!-- 错误恢复路径 -->
  <rect x="950" y="1100" width="160" height="60" class="error" />
  <text x="1030" y="1120" class="text">统一错误处理</text>
  <text x="1030" y="1135" class="text">- 指数退避重试</text>
  <text x="1030" y="1150" class="text">- 智能恢复策略</text>
  
  <!-- 连接线 -->
  <line x1="600" y1="100" x2="600" y2="130" class="arrow" />
  <line x1="600" y1="170" x2="600" y2="200" class="arrow" />
  <line x1="600" y1="240" x2="600" y2="270" class="arrow" />
  <line x1="600" y1="310" x2="600" y2="320" class="arrow" />
  
  <!-- 语音错误 -->
  <line x1="680" y1="340" x2="750" y2="340" class="error-arrow" />
  <text x="715" y="335" class="text" font-size="10">否</text>
  
  <!-- 语音成功 -->
  <line x1="600" y1="360" x2="600" y2="390" class="arrow" />
  <text x="615" y="375" class="text" font-size="10">是</text>
  
  <line x1="600" y1="430" x2="600" y2="440" class="arrow" />
  
  <!-- 认证失败 -->
  <line x1="680" y1="460" x2="750" y2="460" class="error-arrow" />
  <text x="715" y="455" class="text" font-size="10">否</text>
  
  <!-- 认证成功 -->
  <line x1="600" y1="480" x2="600" y2="510" class="arrow" />
  <text x="615" y="495" class="text" font-size="10">是</text>
  
  <line x1="600" y1="550" x2="600" y2="580" class="arrow" />
  <line x1="600" y1="620" x2="600" y2="630" class="arrow" />
  
  <!-- API错误 -->
  <line x1="680" y1="650" x2="750" y2="650" class="error-arrow" />
  <text x="715" y="645" class="text" font-size="10">否</text>
  
  <!-- API成功 -->
  <line x1="600" y1="670" x2="600" y2="700" class="arrow" />
  <text x="615" y="685" class="text" font-size="10">是</text>
  
  <!-- 需要工具调用 -->
  <line x1="520" y1="720" x2="430" y2="770" class="arrow" />
  <text x="465" y="740" class="text" font-size="10">是</text>
  
  <!-- 不需要工具调用 -->
  <line x1="680" y1="720" x2="770" y2="770" class="arrow" />
  <text x="735" y="740" class="text" font-size="10">否</text>
  
  <!-- 工具调用流程 -->
  <line x1="430" y1="810" x2="350" y2="820" class="arrow" />
  
  <!-- 确认选项 -->
  <line x1="270" y1="840" x2="160" y2="890" class="arrow" />
  <text x="200" y="860" class="text" font-size="10">确认</text>
  
  <line x1="350" y1="860" x2="310" y2="890" class="arrow" />
  <text x="330" y="880" class="text" font-size="10">取消</text>
  
  <line x1="430" y1="840" x2="460" y2="890" class="arrow" />
  <text x="450" y="860" class="text" font-size="10">重试</text>
  
  <!-- 执行工具 -->
  <line x1="160" y1="930" x2="350" y2="960" class="arrow" />
  <line x1="350" y1="1000" x2="350" y2="1010" class="arrow" />
  
  <!-- 工具错误 -->
  <line x1="270" y1="1030" x2="160" y2="1030" class="error-arrow" />
  <text x="215" y="1025" class="text" font-size="10">否</text>
  
  <!-- 工具成功 -->
  <line x1="350" y1="1050" x2="600" y2="1100" class="arrow" />
  <text x="475" y="1070" class="text" font-size="10">是</text>
  
  <!-- 直接响应 -->
  <line x1="770" y1="810" x2="600" y2="1100" class="arrow" />
  
  <!-- 最终流程 -->
  <line x1="600" y1="1140" x2="600" y2="1170" class="arrow" />
  <line x1="600" y1="1210" x2="600" y2="1240" class="arrow" />
  <line x1="600" y1="1280" x2="600" y2="1310" class="arrow" />
  
  <!-- 错误恢复连接 -->
  <line x1="830" y1="360" x2="1030" y2="1100" class="error-arrow" />
  <line x1="830" y1="480" x2="1030" y2="1100" class="error-arrow" />
  <line x1="830" y1="670" x2="1030" y2="1100" class="error-arrow" />
  <line x1="160" y1="1050" x2="1030" y2="1100" class="error-arrow" />
  
  <!-- 重试循环 -->
  <path d="M 460 930 Q 500 950 500 1000 Q 500 1050 460 1070 Q 420 1090 380 1070 Q 340 1050 340 1000 Q 340 950 380 930" 
        fill="none" stroke="#f57c00" stroke-width="2" stroke-dasharray="5,5" />
  <text x="430" y="1000" class="text" font-size="10">重试循环</text>
  
  <!-- 取消回到开始 -->
  <path d="M 310 930 Q 50 950 50 680 Q 50 400 520 400" 
        fill="none" stroke="#d32f2f" stroke-width="2" stroke-dasharray="5,5" />
  <text x="280" y="680" class="text" font-size="10">取消重置</text>
  
  <!-- 错误恢复回到开始 -->
  <path d="M 1030 1160 Q 1150 1200 1150 680 Q 1150 400 680 400" 
        fill="none" stroke="#d32f2f" stroke-width="2" stroke-dasharray="5,5" />
  <text x="1100" y="800" class="text" font-size="10">错误恢复</text>
  
  <!-- 图例 -->
  <rect x="50" y="1400" width="300" height="150" fill="none" stroke="#333" stroke-width="1" />
  <text x="200" y="1420" class="title">图例说明</text>
  
  <rect x="70" y="1430" width="60" height="20" class="box" />
  <text x="140" y="1445" class="text" font-size="10">用户操作</text>
  
  <rect x="70" y="1460" width="60" height="20" class="process" />
  <text x="140" y="1475" class="text" font-size="10">系统处理</text>
  
  <polygon points="70,1490 100,1480 130,1490 100,1500" class="decision" />
  <text x="140" y="1495" class="text" font-size="10">判断决策</text>
  
  <rect x="70" y="1510" width="60" height="20" class="error" />
  <text x="140" y="1525" class="text" font-size="10">错误处理</text>
  
  <line x1="200" y1="1440" x2="250" y2="1440" class="arrow" />
  <text x="260" y="1445" class="text" font-size="10">正常流程</text>
  
  <line x1="200" y1="1460" x2="250" y2="1460" class="error-arrow" />
  <text x="260" y="1465" class="text" font-size="10">错误流程</text>
  
  <line x1="200" y1="1480" x2="250" y2="1480" stroke="#f57c00" stroke-width="2" stroke-dasharray="5,5" fill="none" />
  <text x="260" y="1485" class="text" font-size="10">重试/恢复</text>
</svg>