# 全语音AI-Agent平台 后端开发文档

**技术栈**：Python 3.9+，FastAPI，Uvicorn，SQLAlchemy，Alembic，Pydantic，PyMySQL，JWT，OpenAI Python SDK，aiohttp，loguru，pytest

---

## 目录
1. 概览
2. 项目结构
3. 环境与依赖管理
4. 配置说明
5. 数据库模型与迁移
6. 核心服务组件
   - 6.1 路由（Routers）
   - 6.2 控制器（Controllers）
   - 6.3 服务层（Services）
   - 6.4 客户端（Clients）
7. API 接口定义
   - 7.1 /v1/api/interpret
   - 7.2 /v1/api/execute
   - 7.3 /v1/api/tools
   - 7.4 健康检查
8. 错误处理与日志
9. 身份认证（JWT）
10. 集成测试与单元测试
11. 本地启动与部署
12. 后续迭代规划

---

## 1. 概览
该文档面向后端开发团队，覆盖从环境配置、数据库设计、核心业务流程、API 细节到测试部署的全流程。保证开发人员能“一看就会”、“对照即做”。

---

## 2. 项目结构
```text
app/
├── main.py               # FastAPI 应用实例与中间件注册
├── config.py             # 配置管理 (.env 变量映射)
├── routers/              # 路由模块
│   ├── interpret.py      # /v1/api/interpret
│   ├── execute.py        # /v1/api/execute
│   └── tools.py          # /v1/api/tools
├── controllers/          # 控制器：请求校验与响应封装
│   ├── interpret.py
│   ├── execute.py
│   └── tools.py
├── services/             # 业务逻辑层
│   ├── interpret_service.py
│   ├── execute_service.py
│   └── tool_service.py
├── clients/              # 第三方/内部客户端封装
│   ├── openai_client.py
│   ├── mcp_client.py
│   └── http_client.py
├── models/               # SQLAlchemy ORM 模型
│   ├── user.py
│   ├── tool.py
│   ├── session.py
│   └── log.py
├── schemas/              # Pydantic 请求/响应 schema
│   ├── interpret.py
│   ├── execute.py
│   └── tool.py
├── utils/                # 通用工具
│   ├── db.py             # SQLAlchemy engine & session
│   ├── logger.py         # loguru 配置
│   └── dependencies.py   # FastAPI 依赖注入
├── alembic/              # 数据库迁移配置与脚本
└── tests/                # 单元测试与集成测试
    ├── unit/
    └── integration/
```

---

## 3. 环境与依赖管理
1. 安装 Python 3.9+ 环境
2. 克隆仓库并创建虚拟环境：
   ```bash
   git clone <repo_url>
   cd repo
   python -m venv venv
   source venv/bin/activate
   ```
3. 安装依赖：
   ```bash
   pip install -r requirements.txt
   ```
4. Requirements.txt 样例：
   ```text
   fastapi
   uvicorn[standard]
   sqlalchemy
   pymysql
   alembic
   pydantic
   python-dotenv
   loguru
   openai
   aiohttp
   pytest
   pytest-asyncio
   httpx
   ```

---

## 4. 配置说明 (`config.py`)
```python
from pydantic import BaseSettings

class Settings(BaseSettings):
    APP_NAME: str = "FullVoiceAI"
    ENV: str = "development"
    DEBUG: bool = True
    PORT: int = 8000
    DB_URL: str                               # e.g. mysql+pymysql://user:pass@host:3306/db
    JWT_SECRET: str
    OPENAI_API_KEY: str
    MCP_SCRIPT_PATH: str
    MCP_MAX_RETRY: int = 3
    MCP_TIMEOUT_MS: int = 30000

    class Config:
        env_file = ".env"

settings = Settings()
```

---

## 5. 数据库模型与迁移
### 5.1 SQLAlchemy 模型示例
```python
# models/user.py
from sqlalchemy import Column, BigInteger, String, JSON, DateTime
from datetime import datetime
from utils.db import Base

class User(Base):
    __tablename__ = 'users'
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    username = Column(String(64), unique=True, nullable=False)
    contacts = Column(JSON)
    wallets = Column(JSON)
    created_at = Column(DateTime, default=datetime.utcnow)
```
### 5.2 Alembic 迁移
- `alembic.ini` 指向 `config.py` 的 DB_URL
- 示例迁移脚本：
```python
# alembic/versions/xxxx_create_users.py
def upgrade():
    op.create_table('users',
        sa.Column('id', sa.BigInteger(), primary_key=True),
        sa.Column('username', sa.String(64), nullable=False, unique=True),
        sa.Column('contacts', sa.JSON()),
        sa.Column('wallets', sa.JSON()),
        sa.Column('created_at', sa.DateTime(), server_default=sa.func.now())
    )

def downgrade():
    op.drop_table('users')
```

---

## 6. 核心服务组件
### 6.1 路由（routers）
```python
# routers/interpret.py
from fastapi import APIRouter, Depends
from schemas.interpret import InterpretRequest, InterpretResponse
from controllers.interpret import interpret_controller

router = APIRouter(prefix="/v1/api")

@router.post("/interpret", response_model=InterpretResponse)
async def interpret(req: InterpretRequest):
    return await interpret_controller(req)
```

### 6.2 控制器（controllers）
```python
# controllers/interpret.py
from services.interpret_service import InterpretService

async def interpret_controller(req):
    result = await InterpretService.parse_intent(req.sessionId, req.userId, req.text)
    return result
```

### 6.3 服务层（services）
```python
# services/interpret_service.py
from models.session import Session
from clients.openai_client import OpenAIClient
from utils.db import db_session
from models.log import Log

class InterpretService:
    @staticmethod
    async def parse_intent(sessionId, userId, text):
        # 1. 创建或更新 session
        session = Session.get_or_create(sessionId, userId)
        session.status = 'interpreting'
        db_session.commit()
        # 2. 调用 OpenAI
        action, params, confirmText = await OpenAIClient.parse(text)
        # 3. 写日志
        Log.create(sessionId=sessionId, step='interpret', status='success', message=confirmText)
        # 4. 返回数据
        return {"type":"confirm","action":action,"params":params,"confirmText":confirmText}
```

### 6.4 客户端（clients）
```python
# clients/mcp_client.py
import asyncio
from mcp.client.stdio import stdio_client
from mcp.client.stdio import StdioServerParameters
from config import settings

class MCPClient:
    _session = None

    @classmethod
    async def connect(cls):
        if cls._session: return
        params = StdioServerParameters(
            command="python",
            args=[settings.MCP_SCRIPT_PATH],
            max_retry=settings.MCP_MAX_RETRY,
            timeout_ms=settings.MCP_TIMEOUT_MS
        )
        cls._session = await stdio_client(params)

    @classmethod
    async def call_tool(cls, tool_name, params):
        await cls.connect()
        return await cls._session.call_tool(tool_name, params)
```

---

## 7. API 接口定义
### 7.1 POST /v1/api/interpret
- 请求/响应见 Pydantic Schema (schemas/interpret.py)
- HTTP 200: InterpretResponse
- 错误示例:
  ```json
  {"error":{"code":"INVALID_PARAM","msg":"参数错误"}}
  ```

### 7.2 POST /v1/api/execute
- 请求: ExecuteRequest
- 成功：
  ```json
  {"success":true,"data":{/* tool result */}}
  ```
- 失败：
  ```json
  {"success":false,"error":{"code":"EXEC_FAIL","message":"调用失败"}}
  ```

### 7.3 GET /v1/api/tools
- 返回已注册工具列表

### 7.4 GET /health
- 负载与依赖健康检查

---

## 8. 错误处理与日志
- 全局异常中间件捕获 HTTPException 与 Exception，返回统一格式
- `loguru` 配置，ERROR 级别入文件，INFO 控制台
- 日志表 `logs` 记录每步操作，便于追踪和排查

---

## 9. 身份认证（JWT）
- 登录接口定制（非文档），颁发 JWT
- `Authorization: Bearer <token>` 中间件校验，`req.userId = payload['sub']`

---

## 10. 集成测试与单元测试
- 使用 `pytest` 与 `pytest-asyncio`
- 单元测试覆盖 services 与 utils
- 集成测试使用 `httpx.AsyncClient` 测试 routers

---

## 11. 本地启动与部署
1. 创建并激活虚拟环境
2. 安装依赖：`pip install -r requirements.txt`
3. 配置 `.env`
4. 迁移数据库：`alembic upgrade head`
5. 启动服务：`uvicorn app.main:app --reload --host 0.0.0.0 --port ${PORT}`
6. 访问 `http://localhost:${PORT}/docs` 查看自动生成的 Swagger UI

---

## 12. 后续迭代规划
- `/v1/api/confirm` 多轮确认接口  
- 并行/串联多工具调用支持  
- 集成 Prometheus + Grafana 监控  
- 缓存(`Redis`) 会话与工具元数据  
- 完善 CI/CD 与 Kubernetes 部署指南

---

> 文档更新时间：2025-04-28  
> 文档负责人：后端团队 Lead

