# 全语音AI-Agent平台 后端开发文档

**技术栈**：Python 3.9+，FastAPI，Uvicorn，SQLAlchemy，Alembic，Pydantic，PyMySQL，JWT，OpenAI Python SDK，aiohttp，loguru，pytest

---

## 目录
1. 概览
2. 项目结构
3. 环境与依赖管理
4. 配置说明
5. 数据库模型与迁移
6. 核心服务组件
   - 6.1 路由（Routers）
   - 6.2 控制器（Controllers）
   - 6.3 服务层（Services）
   - 6.4 客户端（Clients）
7. API 接口定义
   - 7.1 /v1/api/interpret
   - 7.2 /v1/api/execute
   - 7.3 /v1/api/tools
   - 7.4 健康检查
8. 错误处理与日志
9. 身份认证（JWT）
10. 集成测试与单元测试
11. 本地启动与部署
12. 支持的工具类型
13. 后续迭代规划

---

## 1. 概览
该文档面向后端开发团队，覆盖从环境配置、数据库设计、核心业务流程、API 细节到测试部署的全流程。保证开发人员能"一看就会"、"对照即做"。

---

## 2. 项目结构
### 完整目录结构
```text
backend/
├── alembic/                    # 数据库迁移配置与脚本
│   ├── versions/               # 迁移版本脚本
│   ├── env.py                  # Alembic环境配置
│   └── alembic.ini             # Alembic配置文件
├── app/                        # 应用主目录
│   ├── clients/                # 第三方/内部客户端封装
│   │   ├── openai_client.py    # OpenAI/兼容LLM客户端
│   │   ├── mcp_client.py       # MCP客户端
│   │   └── http_client.py      # HTTP请求客户端
│   ├── controllers/            # 控制器：请求校验与响应封装
│   │   ├── interpret.py        # 意图解析控制器
│   │   ├── execute.py          # 工具执行控制器
│   │   └── tools.py            # 工具管理控制器
│   ├── models/                 # SQLAlchemy ORM 模型
│   │   ├── user.py             # 用户模型
│   │   ├── tool.py             # 工具模型
│   │   ├── session.py          # 会话模型
│   │   └── log.py              # 日志模型
│   ├── routers/                # 路由模块
│   │   ├── interpret.py        # /v1/api/interpret
│   │   ├── execute.py          # /v1/api/execute
│   │   └── tools.py            # /v1/api/tools
│   ├── schemas/                # Pydantic 请求/响应 schema
│   │   ├── interpret.py        # 意图解析Schema
│   │   ├── execute.py          # 工具执行Schema
│   │   └── tool.py             # 工具管理Schema
│   ├── services/               # 业务逻辑层
│   │   ├── interpret_service.py # 意图解析服务
│   │   ├── execute_service.py   # 工具执行服务
│   │   └── tool_service.py      # 工具管理服务
│   ├── utils/                  # 通用工具
│   │   ├── db.py               # SQLAlchemy engine & session
│   │   ├── logger.py           # loguru 配置
│   │   └── dependencies.py     # FastAPI 依赖注入
│   ├── config.py               # 配置管理 (.env 变量映射)
│   └── main.py                 # FastAPI 应用实例与中间件注册
├── logs/                       # 日志文件目录
├── scripts/                    # 辅助脚本
├── tests/                      # 测试代码
│   ├── test_execute_service.py # 工具执行服务测试
│   ├── test_interpret_api.py   # 意图解析API测试
│   └── test_auth.py            # 认证功能测试
├── .env.example                # 环境变量示例
├── alembic.ini                 # Alembic配置
├── requirements.txt            # 依赖包列表
└── pytest.ini                  # pytest配置
```

### 核心文件详解
- **main.py**: FastAPI应用入口，注册中间件和路由
- **config.py**: 环境变量加载和应用配置
- **services/execute_service.py**: 工具执行逻辑，支持MCP和各类HTTP工具
- **services/interpret_service.py**: 意图解析逻辑，使用LLM解析用户输入
- **clients/mcp_client.py**: MCP客户端封装，处理MCP工具调用
- **clients/http_client.py**: HTTP客户端，处理HTTP类型工具调用
- **models/tool.py**: 工具数据库模型，定义工具属性和关系

---

## 3. 环境与依赖管理
1. 安装 Python 3.9+ 环境
2. 克隆仓库并创建虚拟环境：
   ```bash
   git clone <repo_url>
   cd repo/backend
   python -m venv venv
   source venv/bin/activate  # Linux/Mac
   # 或
   venv\Scripts\activate  # Windows
   ```
3. 安装依赖：
   ```bash
   pip install -r requirements.txt
   ```
4. 完整 requirements.txt：
   ```text
   fastapi>=0.95.0
   uvicorn[standard]>=0.22.0
   sqlalchemy>=2.0.0
   pymysql>=1.0.3
   alembic>=1.11.0
   pydantic>=2.0.0
   python-dotenv>=1.0.0
   loguru>=0.7.0
   openai>=1.1.0
   anthropic>=0.3.0
   aiohttp>=3.8.5
   httpx>=0.24.0
   pytest>=7.3.1
   pytest-asyncio>=0.21.0
   python-jose>=3.3.0
   passlib>=1.7.4
   python-multipart>=0.0.6
   bcrypt>=4.0.1
   ```

---

## 4. 配置说明 (`config.py` 和 `.env`)
### 配置类 (config.py)
```python
from pydantic import BaseSettings, Field

class Settings(BaseSettings):
    APP_NAME: str = "FullVoiceAI"
    ENV: str = "development"
    DEBUG: bool = True
    PORT: int = 8000
    
    # 数据库配置
    DB_USER: str
    DB_PASSWORD: str
    DB_HOST: str
    DB_PORT: int = 3306
    DB_NAME: str
    DB_URL: str = None
    
    # 认证
    JWT_SECRET: str
    JWT_ALGORITHM: str = "HS256"
    ACCESS_TOKEN_EXPIRE_MINUTES: int = 60 * 24 * 7  # 7天
    
    # LLM配置
    LLM_PROVIDER: str = "openai"  # openai, anthropic等
    LLM_API_KEY: str
    LLM_MODEL: str = "gpt-4o"
    LLM_API_BASE: str = None
    
    # MCP配置
    MCP_SCRIPT_PATH: str
    MCP_MAX_RETRY: int = 3
    MCP_TIMEOUT_MS: int = 30000

    class Config:
        env_file = ".env"
        
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        if not self.DB_URL:
            self.DB_URL = f"mysql+pymysql://{self.DB_USER}:{self.DB_PASSWORD}@{self.DB_HOST}:{self.DB_PORT}/{self.DB_NAME}"

settings = Settings()
```

### .env 文件示例
```
# 应用基础配置
APP_NAME=FullVoiceAI
ENV=development
DEBUG=true
PORT=8000

# 数据库配置
DB_USER=myuser
DB_PASSWORD=mypassword
DB_HOST=localhost
DB_PORT=3306
DB_NAME=voiceai

# 认证配置
JWT_SECRET=your-super-secret-key-here
JWT_ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=10080  # 7天

# LLM配置
LLM_PROVIDER=openai
LLM_API_KEY=your-openai-api-key
LLM_MODEL=gpt-4o
# LLM_API_BASE=https://api.openai.com/v1  # 可选，自定义API基础URL

# MCP配置
MCP_SCRIPT_PATH=/path/to/mcp/script.py
MCP_MAX_RETRY=3
MCP_TIMEOUT_MS=30000
```

---

## 5. 数据库模型与迁移
### 5.1 SQLAlchemy 模型
#### User 模型
```python
# models/user.py
from sqlalchemy import Column, BigInteger, String, JSON, DateTime
from datetime import datetime
from utils.db import Base

class User(Base):
    __tablename__ = 'users'
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    username = Column(String(64), unique=True, nullable=False)
    email = Column(String(128), unique=True, nullable=False)
    password_hash = Column(String(256), nullable=False)
    contacts = Column(JSON)
    wallets = Column(JSON)
    created_at = Column(DateTime, default=datetime.utcnow)
```

#### Tool 模型
```python
# models/tool.py
from sqlalchemy import Column, String, Enum, JSON, DateTime
from datetime import datetime
from utils.db import Base

class Tool(Base):
    __tablename__ = 'tools'
    tool_id = Column(String(64), primary_key=True)
    name = Column(String(128), nullable=False)
    type = Column(Enum('mcp', 'http'), nullable=False)
    description = Column(String(512))
    server_name = Column(String(64))  # 仅对MCP工具
    endpoint = Column(JSON, nullable=False)
    request_schema = Column(JSON, nullable=False)
    response_schema = Column(JSON, nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)
```

#### Session 模型
```python
# models/session.py
from sqlalchemy import Column, String, BigInteger, Enum, DateTime, ForeignKey
from sqlalchemy.sql import func
from utils.db import Base

class Session(Base):
    __tablename__ = 'sessions'
    session_id = Column(String(36), primary_key=True)
    user_id = Column(BigInteger, ForeignKey('users.id'), nullable=False)
    status = Column(Enum('interpreting', 'waiting_confirm', 'executing', 'done', 'error'), nullable=False)
    created_at = Column(DateTime, default=func.now())
    updated_at = Column(DateTime, default=func.now(), onupdate=func.now())
```

### 5.2 Alembic 迁移
- 初始化迁移：
  ```bash
  cd backend
  alembic init alembic
  ```

- 创建迁移脚本：
  ```bash
  alembic revision --autogenerate -m "创建初始表"
  ```

- 执行迁移：
  ```bash
  alembic upgrade head
  ```

- 示例迁移脚本 (tools表添加server_name字段)：
  ```python
  # alembic/versions/xxxx_add_server_name_to_tools.py
  def upgrade():
      op.add_column('tools', sa.Column('server_name', sa.String(64), nullable=True))

  def downgrade():
      op.drop_column('tools', 'server_name')
  ```

## 11. 本地启动与部署
1. 创建并激活虚拟环境：
   ```bash
   cd backend
   python -m venv venv
   source venv/bin/activate  # Linux/Mac
   # 或
   venv\Scripts\activate  # Windows
   ```

2. 安装依赖：
   ```bash
   pip install -r requirements.txt
   ```

3. 配置 `.env` 文件（从 `.env.example` 复制创建）：
   ```bash
   cp .env.example .env
   # 编辑 .env 并设置所有必需的环境变量
   ```

4. 迁移数据库：
   ```bash
   alembic upgrade head
   ```

5. 启动服务：
   ```bash
   # 开发模式，自动重载
   uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
   
   # 生产模式
   uvicorn app.main:app --host 0.0.0.0 --port 8000
   ```

6. 使用PM2启动（生产环境推荐）：
   ```bash
   # 安装PM2 (需要Node.js)
   npm install -g pm2
   
   # 创建PM2配置文件 ecosystem.config.js
   # 启动服务
   pm2 start ecosystem.config.js
   ```

7. 访问 Swagger UI：
   - http://localhost:8000/docs

## 12. 支持的工具类型

系统支持两种主要类型的工具：MCP工具和HTTP工具。

### 12.1 MCP工具
MCP (Multi-Chain Protocol) 工具是基于自定义协议的脚本工具，能够执行区块链相关操作和其他复杂任务。

- 要求配置 `server_name` 字段，指向对应的MCP服务器
- 支持完整的参数传递和结果解析
- 集成了多种MCP服务器，如Playwright、MiniMax API、地图API和Web3区块链API

### 12.2 HTTP工具
HTTP工具允许系统调用外部HTTP API来执行操作。目前支持以下平台类型：

1. **Dify**: 调用Dify平台上的AI应用
   - 支持 conversation_id 管理
   - 响应进行LLM总结处理，输出适合语音播报的内容

2. **Coze**: 调用Coze平台上的机器人
   - 要求在配置中提供 bot_id
   - 响应同样经过LLM总结处理

3. **通用HTTP**: 支持配置和调用任意HTTP API
   - 支持 GET, POST, PUT, PATCH, DELETE 等多种HTTP方法
   - 灵活配置头信息、认证方式（Bearer、ApiKey、Basic）
   - 支持响应结果路径提取（使用 result_path 字段）
   - 支持URL参数格式化和有效载荷配置
   - 对响应结果进行LLM总结处理，生成简洁易懂的语音反馈

### 12.3 示例工具配置
```sql
-- Dify工具示例
INSERT INTO tools (tool_id, name, type, description, endpoint, request_schema, response_schema)
VALUES (
    'dify-chat-default',
    'Dify AI助手',
    'http',
    '通用AI对话助手',
    '{
        "platform": "dify",
        "api_key": "your-dify-api-key",
        "app_id": "your-dify-app-id"
    }',
    '{"type": "object", "properties": {"query": {"type": "string"}}}',
    '{"type": "object", "properties": {"response": {"type": "string"}}}'
);

-- Coze工具示例
INSERT INTO tools (tool_id, name, type, description, endpoint, request_schema, response_schema)
VALUES (
    'coze-chat-default',
    'Coze机器人',
    'http',
    '通用AI对话机器人',
    '{
        "platform": "coze",
        "api_key": "your-coze-api-key",
        "bot_id": "your-coze-bot-id"
    }',
    '{"type": "object", "properties": {"query": {"type": "string"}}}',
    '{"type": "object", "properties": {"response": {"type": "string"}}}'
);

-- 通用HTTP工具示例
INSERT INTO tools (tool_id, name, type, description, endpoint, request_schema, response_schema)
VALUES (
    'weather-api',
    '天气预报API',
    'http',
    '查询城市天气预报',
    '{
        "platform": "generic",
        "api_key": "your-api-key-here",
        "app_config": {
            "url": "https://api.example.com/weather/{city}",
            "method": "GET",
            "auth_type": "Bearer",
            "headers": {"accept": "application/json"},
            "timeout": 20,
            "result_path": "data.forecast"
        }
    }',
    '{"type": "object", "properties": {"city": {"type": "string"}}}',
    '{"type": "object", "properties": {"forecast": {"type": "string"}}}'
);
```

## 13. 后续迭代规划
- `/v1/api/confirm` 多轮确认接口  
- 并行/串联多工具调用支持  
- 集成 Prometheus + Grafana 监控  
- 缓存(`Redis`) 会话与工具元数据  
- 完善 CI/CD 与 Kubernetes 部署指南

---

> 文档更新时间：2025-05-14  
> 文档负责人：后端团队 Lead

